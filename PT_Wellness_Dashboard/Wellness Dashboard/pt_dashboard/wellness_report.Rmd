---
format:
  html:
    embed-resources: true
    theme: journal
editor: visual
output:
  html_document:
  pdf_document: 
    keep_tex: true
params:
  data: NA
  patient: NA
  therapist: NA
  roll_window: NA
  current_dir: getwd()
execute:
  echo: false
  warnings: false
  cache: false
runtime: shiny
---

:::::: {.cols style="display: flex"}

::: col-md-8
<h1>`r paste('Wellness Report - ', params$patient, sep = '')`</h1>

<h2>PT: `r params$therapist`</h2>

:::

::: col-md-4
![](logo.png){width="100%"}
:::

::::::

```{r, echo=FALSE, out.width="50%"}
# htmltools::img(src = "logo.png", 
#                alt = 'logo', 
#                style = 'position:absolute; top:0; right:0; padding:10px; height=20px')
```

```{r}
#| echo:    FALSE
#| message: FALSE
#| warning: FALSE

library(kableExtra)
library(shiny)
library(tidyverse)
library(zoo)
library(ggplot2)
library(knitr)
library(grid)
library(readxl)

rolling_mean <- function(x) {
  rollmean(x, k = 3, fill = NA, align = 'right')
}

scale_func <- function(x) {
  sprintf("%.1f", x)
}

perc_change <- function(x) {
  round((tail(x, 1) - head(x, 1)) / head(x, 1) * 100, digits = 1)
}

opts_knit$set(
  root.dir = getwd()
)

```

```{r}
#| echo:    FALSE
#| message: FALSE
#| warning: FALSE

data <- params$data
data <- data[data$Name == params$patient, ]

```

:::::: {.cols style="display: flex; text-align: center; font-size: 20px"}
::: col-md-4
### SANE

`r perc_change(data$SANE)`%
:::

::: col-md-4
### Performance

`r perc_change(data$Performance)`%
:::

::: col-md-4
### Wellness

`r perc_change(data$Wellness)`%
:::
::::::

:::::: {.cols style="display: flex; text-align: center; font-size: 20px"}
::: col-md-4
### Sleep

`r perc_change(data$Sleep)`%
:::

::: col-md-4
### Frequency

`r perc_change(data$Frequency)`%
:::

::: col-md-4
### Severity

`r perc_change(data$Severity)`%
:::
::::::

```{r}
#| echo:    FALSE
#| message: FALSE
#| warning: FALSE
#| output: asis
#| out-width: 100%

plot <- data %>%
  pivot_longer(
    cols = !c(Date, Name, Therapist),
    names_to = "Question",
    values_to = "Response",
    values_drop_na = TRUE
  ) %>%
  group_by(Question) %>%
  mutate(roll_mean = rollmean(Response, 
                              k = as.integer(params$roll_window),
                              fill = NA, align = 'right')) %>%
  mutate(Question = factor(Question, 
                           levels = c('SANE', 'Performance', 'Wellness', 'Sleep', 'Frequency', 'Severity'))) %>%
  ggplot(mapping = aes(x = Date, y = Response)) +
  geom_area(aes(color = Question, fill = Question, alpha = 0.5)) +
  geom_point()

if (length(data$Name) > 1) {
  plot <- plot + 
    geom_line(aes(y = roll_mean))
}

plot <- plot +
  facet_wrap(~Question, nrow = 2, scales = 'free') +
  theme_gray() +
  theme(legend.position = 'none',
        panel.spacing = unit(2, 'lines'),
        axis.title.y = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(labels = scale_func)

plot
```


