---
title: "`r paste('Wellness Report - ', params$patient, sep = '')`"
subtitle: "`r params$therapist`"
format:
  html:
    embed-resources: true
    theme: journal
editor: visual
output:
  html_document:
  pdf_document: 
    keep_tex: true
params:
  data: NA
  patient: NA
  therapist: NA
  roll_window: NA
  current_dir: getwd()
execute:
  echo: false
  warnings: false
  cache: false
runtime: shiny
---

```{r}
#| echo:    FALSE
#| message: FALSE
#| warning: FALSE

library(kableExtra)
library(shiny)
library(tidyverse)
library(zoo)
library(ggplot2)
library(knitr)
library(grid)
library(readxl)

rolling_mean <- function(x) {
  rollmean(x, k = 3, fill = NA, align = 'right')
}

scale_func <- function(x) {
  sprintf("%.1f", x)
}

opts_knit$set(
  root.dir = getwd()
)



# test_path <- "C:/Users/Caitie Mayo/OneDrive - Architech Sports and Physical Therapy/Performance Analyst/Wellness Questionnaire/Physical Therapy Wellness Questionnaire/pt_wellness_questionnaire.xlsx"
# params$data <- read_excel(path = test_path, sheet = 'Form1')
# params$patients <- unique(data$`What is your name?`)
# params$therapist <- unique(data$`Who is your Physical Therapist?`)

```

``` {r}
#| echo:    FALSE
#| message: FALSE
#| warning: FALSE

# # Create Patient Select Dropdown
# selectInput(
#   inputId  = 'patientSelect',
#   label    = 'Select patient to view',
#   choices  = patients,
#   selected = head(patients, 1)
# )


```


```{r}
#| echo:    FALSE
#| message: FALSE
#| warning: FALSE
#| output: asis

data <- params$data
data <- data[data$Name == params$patient, ]

data %>%
  pivot_longer(
    cols = !c(Date, Name, Therapist),
    names_to = "Question",
    values_to = "Response",
    values_drop_na = TRUE
  ) %>%
  group_by(Question) %>%
  mutate(roll_mean = rollmean(Response, 
                              k = params$roll_window, 
                              fill = NA, 
                              align = 'right')) %>%
  mutate(Question = factor(Question, 
                           levels = c('SANE', 'Performance', 'Wellness', 'Sleep', 'Frequency', 'Severity'))) %>%
  ggplot(mapping = aes(x = Date, y = Response)) +
  geom_area(aes(color = Question, fill = Question, alpha = 0.5)) +
  geom_point() +
  geom_line(aes(y = roll_mean)) +
  facet_wrap(~Question, nrow = 3, scales = 'free') +
  theme_gray() +
  theme(legend.position = 'none',
        panel.spacing = unit(2, 'lines'),
        axis.title.x = element_blank()) +
  scale_y_continuous(labels = scale_func)

# res <- purrr::map_chr(patients, \(hw) {
#     knitr::knit_child('template.Rmd', envir = environment(), quiet = TRUE)
#   })
# cat(res, sep = '\n')
```

